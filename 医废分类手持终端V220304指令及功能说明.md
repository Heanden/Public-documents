#  医废分类手持终端 V220304

###### 指令及功能说明

## 0. 说明

#### 版本关键词：

医废标签备注打印、院内推车路径规划节点打印

#### 版本确认

请首先由蓝牙主机 向 此设备 发送指令

```
GZVERS
```

设备返回版本号为

```
220304
```

表明该设备适用于本手册

#### 编辑历史

| 日期       | 作者 | 描述     |
| ---------- | ---- | -------- |
| 2022-03-08 | CFY  | 首次提交 |
| 2022-03-09 | CFY  | Release  |

## 1. 关键指令添加

#### 1. 医废标签备注打印

由蓝牙主机 向 此设备 **发送指令**

~~~json
{
	"Code": "H0XMZY012203041732P0112345",
	"Remark": "99% 一氧化二氢溶液(99% Dihydrogen Monoxide)",
	"labelType": "SGMWIR"
}
~~~

发送数据指令时**可不包含**回车换行(0x0D 0x0A)

指令内容格式为**JSON**，其中

对象"**Code**"的值为26位医废编码字符串；

对象"**Remark**"的值为医废标签备注，内容编码需为**GBK**格式，中文及符号占2个字节，英文及符号占1个字节，最多容纳58个字节（29个中文字符）；

对象"**labelType**"的固定值为"**SGMWIR**"，表示此医废标签包含备注内容*。

###### *注：为了兼容设备旧版本程序，当医废标签不包含备注内容时，仅向设备发送26位医废编码即可。

**设备返回**

~~~
00000
~~~

![c19671d9bfa2f68ebf700129165f120](https://gitee.com/Heanden/pic/raw/master/img/c19671d9bfa2f68ebf700129165f120.png)

#### 2. 院内推车路径规划节点打印

由蓝牙主机 向 此设备 **发送指令**

~~~json
{
	"Code": "XMZY01NODE220303105442",
	"Remark": "二楼耳鼻喉科2",
	"labelType": "HCRPN"
}
~~~

发送数据指令时**可不包含**回车换行(0x0D 0x0A)

指令内容格式为**JSON**，其中

对象"**Code**"的值为22位院内推车路径规划点位编码字符串；

对象"**Remark**"的值为医废标签备注，内容编码需为**GBK**格式，中文及符号占2个字节，英文及符号占1个字节，最多容纳40个字节（20个中文字符）；

对象"**labelType**"的固定值为"**HCRPN**"，表示此标签为院内推车路径规划点位标签。

**设备返回**

~~~
00000
~~~

![18186484aa269b5c22200d20ad885c4](https://gitee.com/Heanden/pic/raw/master/img/18186484aa269b5c22200d20ad885c4.png)

## 2. 其他指令说明

#### 1. 标定（校准）指令

~~~
GZCL
~~~

参考[标定（校准）说明](https://github.com/Heanden/Public-documents/blob/main/%E5%8C%BB%E5%BA%9F%E5%88%86%E7%B1%BB%E6%89%8B%E6%8C%81%E7%BB%88%E7%AB%AFV220304%E6%8C%87%E4%BB%A4%E5%8F%8A%E5%8A%9F%E8%83%BD%E8%AF%B4%E6%98%8E.md#4-%E6%A0%87%E5%AE%9A%E8%AF%B4%E6%98%8E)

#### 2. 打印标定（校准）参数

~~~
Param
~~~

返回

~~~
%dg: %d //数值的含义为 重量为0g时采样值
%dg: %d //数值的含义为 重量为ng时采样值
%f, %f  //数值的含义分别为 拟合直线(y = kx + b)参数k, b
~~~

#### 3. 切换输出模式

~~~
Debug
~~~

无返回，切换模式为[称重模式](https://github.com/Heanden/Public-documents/blob/main/%E5%8C%BB%E5%BA%9F%E5%88%86%E7%B1%BB%E6%89%8B%E6%8C%81%E7%BB%88%E7%AB%AFV220304%E6%8C%87%E4%BB%A4%E5%8F%8A%E5%8A%9F%E8%83%BD%E8%AF%B4%E6%98%8E.md#1-%E9%BB%98%E8%AE%A4%E7%A7%B0%E9%87%8D%E6%A8%A1%E5%BC%8F)、[调试模式](https://github.com/Heanden/Public-documents/blob/main/%E5%8C%BB%E5%BA%9F%E5%88%86%E7%B1%BB%E6%89%8B%E6%8C%81%E7%BB%88%E7%AB%AFV220304%E6%8C%87%E4%BB%A4%E5%8F%8A%E5%8A%9F%E8%83%BD%E8%AF%B4%E6%98%8E.md#2-%E8%B0%83%E8%AF%95%E6%A8%A1%E5%BC%8F%E5%A4%9A%E6%95%B0%E6%8D%AE%E8%BE%93%E5%87%BA)

#### 4. 去皮（获取并记录皮重）

~~~
GZTARE
~~~

无返回

#### 5. 获取一次原始数据（经过中值平均滤波器）

~~~
GZGET
~~~

返回

~~~
[%d] //经过中值平均滤波器源数值
~~~

#### 6. 打印机命令中转

~~~
CTSxxxCTE // xxx为十六进制，将通过UART总线直接发送至标签打印机
~~~

无返回

#### 7. 打印标签打印机自检页

~~~
GZPTCF
~~~

无返回，打印自检页

#### 8. 调整打印机热参数

~~~
DCddTMdddTIddPTHM
/*
 * 参数解析
 * DCdd     DC: 关键字；数值: 最大加热点数(单位：8点，范围：0-255)
 * TMddd    TM: 关键字；数值: 加热时间(单位: us，范围：0-255)
 * TIdd     TI: 关键字；数值: 加热间隔时间(单位: us，范围：0-255)
 */
~~~

无返回，打印自检页

#### 9. 获取设备版本号

~~~
GZVERS
~~~

返回

~~~
220304
~~~

#### 10. 打印**包含**备注的医废标签

见[医废标签备注打印](https://github.com/Heanden/Public-documents/blob/main/%E5%8C%BB%E5%BA%9F%E5%88%86%E7%B1%BB%E6%89%8B%E6%8C%81%E7%BB%88%E7%AB%AFV220304%E6%8C%87%E4%BB%A4%E5%8F%8A%E5%8A%9F%E8%83%BD%E8%AF%B4%E6%98%8E.md#1-%E5%8C%BB%E5%BA%9F%E6%A0%87%E7%AD%BE%E5%A4%87%E6%B3%A8%E6%89%93%E5%8D%B0)

#### 11. 打印院内推车路径规划节点标签

见[院内推车路径规划节点打印](https://github.com/Heanden/Public-documents/blob/main/%E5%8C%BB%E5%BA%9F%E5%88%86%E7%B1%BB%E6%89%8B%E6%8C%81%E7%BB%88%E7%AB%AFV220304%E6%8C%87%E4%BB%A4%E5%8F%8A%E5%8A%9F%E8%83%BD%E8%AF%B4%E6%98%8E.md#2-%E9%99%A2%E5%86%85%E6%8E%A8%E8%BD%A6%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92%E8%8A%82%E7%82%B9%E6%89%93%E5%8D%B0)

#### 12. 打印**不包含**备注的医废标签

无指令，发送数量满足26位字符串，返回

~~~
00000
~~~

#### 13. 其他字符

返回

~~~
00
~~~

## 3. 模式说明

#### 1. (默认)称重模式

蓝牙主机 连接 设备 成功后，设备直接返回重量测量值(string)

重量测量值发送频率（大约）为1s，除以下情况：

1. 重量测量值过低时，连续发送'0'；

2. 重量测量值趋于稳定时，减小发送频率。

#### 2. 调试模式（多数据输出）

调试数据发送频率（大约）为1s

数据格式为

~~~
convert: %d        //数值的含义为 经过回归计算的测量值
source: %d         //数值的含义为 经过三次滑动平均滤波的源数值
tare: %d           //数值的含义为 皮重(源数值)
relativeSource: %d //数值的含义为 采样值(源数值) - 皮重(源数值)
~~~

## 4. 标定说明

### 1. 准备

蓝牙主机 向 设备 发生指令：

```
GZCL
```

设备 进入重量校准模式，响应：

```
READY
```

### 2. 零刻度校准

蓝牙主机 向 设备 发生指令：

```
SEC0
```

设备 响应：

```
START0
```

设备开始校准零刻度

待 设备 响应：

```
/* 0为原始数据-皮重原始数据，零刻度数值为0即皮重原始数据-皮重原始数据 */
OK0
```

APP 提示完成

### 3. 指定参考重量校准

蓝牙主机 向 设备 发生指令：

```
/* xxxxx：为操作者输入的 参考重量 ，范围1~20000（无需补零）
 * 如参考重量为5g，发送"SEC5"；
 * 又如参考重量为10000g，发"SEC10000"。
 */
SECxxxxx
```

设备 响应：

```
STARTxxxxx /* xxxxx: 说明同上 */
```

设备开始校准指定参考重量

待 设备 响应：

```
/* n为原始数据-皮重原始数据 */
OKn
```

APP 提示校准成功，退出校准功能

### 4. 失败情况

任何时刻 设备 响应：

```
ERRORn /* 有此响应时，设备退出标定（校准）模式 */
```

或等待超过10s未响应，则APP提示退出或重新校准

错误码ERRORn解释

```
/*
 * ERROR1: 设备 向 蓝牙主机 发送"READY"后，蓝牙主机 发送内容不包含"SEC0"。
 * ERROR2: 指定参考重量校准阶段，蓝牙主机 发送内容不包含"SEC"。
 * ERROR3: 指定参考重量校准阶段，蓝牙主机 发送的参考重量信息中，重量数值小于1或大于20000。
 * 其他: Reserve
 */
```
